<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Roboto&family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <title>Health & Dietary Assistant - HAYYAK</title>
    <link rel="icon" type="image/x-icon" href="favicon.png">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- START: Firebase SDK -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
      import { getFirestore, doc, getDoc, setDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
      const firebaseConfig = {
        apiKey: "AIzaSyCog9kvQI1va08Ra_SXzo7ZiUGchTN3Pec",
        authDomain: "hayyak-db039.firebaseapp.com",
        projectId: "hayyak-db039",
        storageBucket: "hayyak-db039.appspot.com",
        messagingSenderId: "766242487044",
        appId: "1:766242487044:web:3e3d4c857afaf88953ee51"
      };
      const app = initializeApp(firebaseConfig);
      window.db = getFirestore(app);
      window.firebase = { doc, getDoc, setDoc, collection, getDocs };
    </script>
    <!-- END: Firebase SDK -->
    <style>
        :root {
            --primary: #16243d;
            --secondary: #2a3851;
            --accent: #D4AF37; /* Gold */
            --light: #f8f9fa;
            --dark: #2c3e50;
            --success: #5cb85c;
            --warning: #f0ad4e;
            --danger: #d9534f;
            --user-msg: #eef2ff;
            --bot-msg: #f5f5f5;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: var(--light);
            color: var(--dark);
            line-height: 1.6;
            font-family: 'Roboto', sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 15px 40px;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header h1 {
            margin: 0;
            font-family: 'Tajawal', sans-serif;
            color: var(--accent);
        }

        h1 {
            font-family: 'Montserrat', sans-serif;
            font-size: 2rem;
            margin-bottom: 5px;
        }

        .tagline {
            font-size: 1rem;
            opacity: 0.9;
            color: var(--accent);
        }

        .home-btn {
            display: inline-block;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            text-decoration: none;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
            transition: var(--transition);
            border: 1px solid transparent;
        }

        .home-btn:hover {
            background: white;
            color: var(--primary);
            border-color: var(--primary);
        }

        .container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .sidebar {
            width: 350px;
            background: white;
            padding: 20px;
            border-right: 1px solid #e0e0e0;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        h3 {
            font-family: 'Montserrat', sans-serif;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .message {
            max-width: 80%;
            padding: 12px 16px;
            margin-bottom: 15px;
            border-radius: 18px;
            position: relative;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .user-message {
            align-self: flex-end;
            background-color: var(--user-msg);
            border-bottom-right-radius: 4px;
        }

        .bot-message {
            align-self: flex-start;
            background-color: var(--bot-msg);
            border-bottom-left-radius: 4px;
        }

        .quick-replies {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .quick-reply {
            background: white;
            border: 1px solid var(--primary);
            color: var(--primary);
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .quick-reply:hover {
            background: var(--primary);
            color: white;
        }

        .chat-input-container {
            padding: 15px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            background: white;
        }

        .chat-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 24px;
            font-size: 1rem;
            outline: none;
            transition: var(--transition);
        }

        .chat-input:focus {
            border-color: var(--primary);
        }

        .send-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            margin-left: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .send-btn:hover {
            background: var(--secondary);
        }

        .food-item {
            background: white;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border-left: 4px solid var(--success);
            transition: var(--transition);
            cursor: pointer;
        }

        .food-item.avoid {
            border-left-color: var(--danger);
            opacity: 0.7;
        }

        .food-item.caution {
            border-left-color: var(--warning);
        }

        .food-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .food-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .food-details {
            font-size: 0.9rem;
            color: #666;
        }

        .recommendation-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
            margin-top: 5px;
        }

        .badge-safe {
            background: rgba(92, 184, 92, 0.2);
            color: var(--success);
        }

        .badge-caution {
            background: rgba(240, 173, 78, 0.2);
            color: var(--warning);
        }

        .badge-avoid {
            background: rgba(217, 83, 79, 0.2);
            color: var(--danger);
        }

        .section-title {
            color: var(--primary);
            margin: 20px 0 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #e0e0e0;
        }

        .typing-indicator {
            display: inline-block;
            padding: 12px 16px;
            background: var(--bot-msg);
            border-radius: 18px;
            border-bottom-left-radius: 4px;
            align-self: flex-start;
        }

        .typing-dots {
            display: inline-block;
        }

        .typing-dots span {
            height: 8px;
            width: 8px;
            background: #999;
            border-radius: 50%;
            display: inline-block;
            margin: 0 2px;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dots span:nth-child(1) { animation-delay: 0s; }
        .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-5px); }
        }

        .suggested-questions {
            margin-top: 20px;
        }

        .suggested-question {
            background: var(--light);
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 8px;
            width: 100%;
            text-align: left;
            cursor: pointer;
            transition: var(--transition);
        }

        .suggested-question:hover {
            background: var(--secondary);
            color: white;
        }

        .browse-by-needs {
            margin-top: 20px;
        }

        .browse-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .browse-btn {
            background: var(--light);
            border: 1px solid var(--primary);
            color: var(--primary);
            padding: 8px;
            border-radius: 5px;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.9rem;
        }
        .browse-btn:hover {
            background: var(--secondary);
            color: white;
        }
        /* Meal Plan Styles */
        .meal-plan-container {
            /* This is now always displayed in the sidebar */
            display: block; 
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: var(--shadow);
        }

        .meal-plan-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .meal-plan-title {
            color: var(--accent);
            font-family: 'Montserrat', sans-serif;
            font-size: 1.5rem;
        }

        .meal-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .meal-card {
            background: var(--light);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .meal-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
        }

        .meal-name {
            font-weight: 600;
            color: var(--primary);
        }

        .meal-time {
            font-size: 0.9rem;
            color: #666;
        }

        .meal-items {
            min-height: 120px;
        }

        .meal-item {
            background: white;
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .meal-item-name {
            font-weight: 500;
        }

        .meal-item-actions {
            display: flex;
            gap: 5px;
        }

        .meal-item-action {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--primary);
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            transition: var(--transition);
        }

        .meal-item-action:hover {
            background: var(--primary);
            color: white;
        }

        .empty-meal {
            text-align: center;
            color: #999;
            font-style: italic;
            padding: 20px 0;
        }

        .meal-plan-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--secondary);
        }

        .btn-secondary {
            background: var(--light);
            color: var(--primary);
            border: 1px solid var(--primary);
        }

        .btn-secondary:hover {
            background: var(--primary);
            color: white;
        }

        .food-selector {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .food-selector-content {
            background: white;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .food-selector-header {
            padding: 15px 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .food-selector-title {
            font-size: 1.3rem;
            font-family: 'Montserrat', sans-serif;
            color: var(--accent);
        }

        .close-selector {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--dark);
        }

        .food-selector-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .food-categories {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .food-category {
            background: var(--light);
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
        }

        .food-category:hover {
            background: var(--secondary);
            color: white;
        }

        .food-category.active {
            background: var(--primary);
            color: white;
        }

        .food-options {
            margin-top: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 10px;
        }

        .food-option {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            transition: var(--transition);
        }

        .food-option:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .nutrition-info {
            font-size: 0.8rem;
            color: #666;
            margin-top: 5px;
        }

        .health-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 5px;
            font-size: 0.8rem;
        }

        .health-safe { color: var(--success); }
        .health-caution { color: var(--warning); }
        .health-avoid { color: var(--danger); }

        /* Responsive Design */
        @media (max-width: 992px) {
            .container {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid #e0e0e0;
            }
        }

        @media (max-width: 768px) {
            header {
                padding: 15px 20px;
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            header h1 {
                font-size: 1.5rem;
            }
            .sidebar {
                max-height: 40vh; /* Allow more space for sidebar content */
            }
            .message {
                max-width: 90%;
            }
            .meal-cards {
                grid-template-columns: 1fr;
            }
            .food-selector-content {
                width: 95%;
                max-height: 90vh;
            }
        }

        .allergy-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 5px;
        }

        .allergy-tag {
            background: rgba(231, 76, 60, 0.1);
            color: var(--danger);
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
        }

        .health-score {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
            margin-left: 10px;
            background: var(--light);
        }

        .score-high { background: rgba(92, 184, 92, 0.2); color: var(--success); }
        .score-medium { background: rgba(240, 173, 78, 0.2); color: var(--warning); }
        .score-low { background: rgba(217, 83, 79, 0.2); color: var(--danger); }
    </style>
</head>
<body>
    <header>
        <div>
            <h1>Health & Dietary Assistant</h1>
            <div class="tagline">Your personal guide to our buffet</div>
        </div>
        <a href="index.html" class="home-btn"><i class="fas fa-home"></i> Return to Home Page</a>
    </header>

    <div class="container">
        <div class="sidebar">
            <!-- Meal Plan Container is now here -->
            <div class="meal-plan-container" id="meal-plan-container">
                <div class="meal-plan-header">
                    <h2 class="meal-plan-title">Your Daily Meal Plan</h2>
                </div>
                <div class="meal-cards">
                    <div class="meal-card" data-meal="breakfast">
                        <div class="meal-card-header">
                            <h3 class="meal-name">Breakfast</h3>
                            <span class="meal-time">7:00 - 10:00 AM</span>
                        </div>
                        <div class="meal-items" id="breakfast-items"></div>
                        <button class="btn btn-secondary" onclick="openFoodSelector('breakfast')">Add Items</button>
                    </div>
                    <div class="meal-card" data-meal="lunch">
                        <div class="meal-card-header">
                            <h3 class="meal-name">Lunch</h3>
                            <span class="meal-time">12:00 - 2:00 PM</span>
                        </div>
                        <div class="meal-items" id="lunch-items"></div>
                        <button class="btn btn-secondary" onclick="openFoodSelector('lunch')">Add Items</button>
                    </div>
                    <div class="meal-card" data-meal="dinner">
                        <div class="meal-card-header">
                            <h3 class="meal-name">Dinner</h3>
                            <span class="meal-time">6:00 - 9:00 PM</span>
                        </div>
                        <div class="meal-items" id="dinner-items"></div>
                        <button class="btn btn-secondary" onclick="openFoodSelector('dinner')">Add Items</button>
                    </div>
                </div>
                <div class="meal-plan-actions">
                    <button class="btn btn-secondary" onclick="generateMealPlan()">Generate New Plan</button>
                    <button class="btn btn-primary" onclick="saveMealPlan()">Save This Plan</button>
                </div>
            </div>
            <!-- New "Free From" Browsing Section -->
            <div class="browse-by-needs">
                <h3 class="section-title">Browse by Dietary Needs</h3>
                <div class="browse-buttons">
                    <button class="browse-btn" onclick="filterAndDisplayBy('gluten')">Gluten-Free</button>
                    <button class="browse-btn" onclick="filterAndDisplayBy('dairy')">Dairy-Free</button>
                    <button class="browse-btn" onclick="filterAndDisplayBy('vegan')">Vegan</button>
                    <button class="browse-btn" onclick="filterAndDisplayBy('low-calorie')">Low-Calorie</button>
                    <button class="browse-btn" onclick="openDietaryBrowser()">Browse All</button>
                </div>
            </div>

            <h3 class="section-title">Recommended Foods</h3>
            <div id="recommended-foods">
                <!-- Recommended foods will appear here -->
            </div>
            
            <div class="suggested-questions">
                <h3 class="section-title">Ask Me About</h3>
                <button class="suggested-question" data-question="What can I eat if I'm allergic to nuts?">Nut Allergy Options</button>
                <button class="suggested-question" data-question="I'm diabetic, what should I avoid?">Diabetes Advice</button>
                <button class="suggested-question" data-question="Show me gluten-free options">Gluten-Free Foods</button>
                <button class="suggested-question" data-question="Show me my meal plan">My Meal Plan</button>
            </div>
        </div>

        <div class="chat-container">
            <div class="chat-messages" id="chat-messages">
                <div class="message bot-message">
                    <i class="fas fa-robot" style="margin-right: 8px;"></i>
                    Hi there! I'm your Health & Dietary Assistant. I can help you navigate our buffet based on your allergies, dietary needs, and health conditions. How can I assist you today?
                    <div class="quick-replies">
                        <div class="quick-reply" data-reply="I have food allergies">I have food allergies</div>
                        <div class="quick-reply" data-reply="I'm on a special diet">I'm on a special diet</div>
                        <div class="quick-reply" data-reply="Show me my meal plan">Show my meal plan</div>
                    </div>
                </div>
            </div>
            
            <div class="chat-input-container">
                <input type="text" class="chat-input" id="user-input" placeholder="Ask about foods, allergies, or dietary needs...">
                <button class="send-btn" id="send-btn">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <footer style="background: var(--primary); color: white; text-align: center; padding: 20px 40px; margin-top: auto;">
        <p>&copy; ABDULLA BIN NASSER 2025. All Rights Reserved.</p>
    </footer>

    <!-- Food Selector Modal -->
    <div class="food-selector" id="food-selector">
        <div class="food-selector-content">
            <div class="food-selector-header">
                <h2 class="food-selector-title">Select Food Items</h2>
                <button class="close-selector" id="close-selector">&times;</button>
            </div>
            <div class="food-selector-body">
                <h3 class="section-title">Food Categories</h3>
                <div class="food-categories" id="food-categories">
                    <!-- Categories will be populated by JavaScript -->
                </div>
                
                <h3 class="section-title">Food Options</h3>
                <div class="food-options" id="food-options">
                    <!-- Food options will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // This will be populated from Firestore
        let foodDatabase = [];

        // Fetch food database from Firestore
        async function fetchFoodDatabase() {
            if (!window.db) return;
            const foodCollection = window.firebase.collection(window.db, "foods");
            const foodSnapshot = await window.firebase.getDocs(foodCollection);
            const foods = [];
            foodSnapshot.forEach(doc => foods.push({ id: doc.id, ...doc.data() }));
            foodDatabase = foods;
            // This is a fallback if the DB is empty, to make the demo work.
            if (foodDatabase.length === 0) { // Expanded fallback database
                foodDatabase = [
                    // Drinks (New Category)
                    { id: "d01", name: "Mineral Water", category: "drinks", allergens: [], cuisine: "International", health: ["hydration"], tags: ["vegan", "gluten-free", "sugar-free"], calories: 0, sugar: 0, sodium: 10, healthScore: 100 },
                    { id: "d02", name: "Fresh Orange Juice", category: "drinks", allergens: [], cuisine: "International", health: ["vitamin-c"], tags: ["vegan", "gluten-free", "healthy"], calories: 110, sugar: 22, sodium: 5, healthScore: 85 },
                    { id: "d03", name: "Green Tea", category: "drinks", allergens: [], cuisine: "Asian", health: ["antioxidants"], tags: ["vegan", "gluten-free", "sugar-free"], calories: 2, sugar: 0, sodium: 5, healthScore: 95 },
                    { id: "d04", name: "Black Coffee", category: "drinks", allergens: [], cuisine: "International", health: ["energy"], tags: ["vegan", "gluten-free", "sugar-free"], calories: 5, sugar: 0, sodium: 5, healthScore: 90 },
                    { id: "d05", name: "Sparkling Water with Lemon", category: "drinks", allergens: [], cuisine: "International", health: ["hydration"], tags: ["vegan", "gluten-free", "sugar-free"], calories: 3, sugar: 0, sodium: 15, healthScore: 98 },
                    { id: "d06", name: "Apple Juice", category: "drinks", allergens: [], cuisine: "International", health: ["vitamins"], tags: ["vegan", "gluten-free"], calories: 115, sugar: 24, sodium: 10, healthScore: 80 },
                    { id: "d07", name: "Iced Tea (Unsweetened)", category: "drinks", allergens: [], cuisine: "American", health: ["hydration"], tags: ["vegan", "gluten-free", "sugar-free"], calories: 5, sugar: 0, sodium: 10, healthScore: 92 },
                    { id: "d08", name: "Milk (2%)", category: "drinks", allergens: ["dairy"], cuisine: "International", health: ["calcium", "protein"], tags: ["vegetarian", "gluten-free"], calories: 122, sugar: 12, sodium: 100, healthScore: 85 },
                    { id: "d09", name: "Soy Milk", category: "drinks", allergens: ["soy"], cuisine: "International", health: ["protein"], tags: ["vegan", "gluten-free", "dairy-free"], calories: 80, sugar: 7, sodium: 90, healthScore: 88 },
                    { id: "d10", name: "Diet Soda", category: "drinks", allergens: [], cuisine: "International", health: [], tags: ["sugar-free"], calories: 1, sugar: 0, sodium: 40, healthScore: 30 },

                    // Appetizers & Sides
                    { id: "a01", name: "Hummus with Pita Bread", category: "appetizer", allergens: ["gluten"], cuisine: "Mediterranean", health: ["fiber", "protein"], tags: ["vegan"], calories: 250, sugar: 2, sodium: 300, healthScore: 75 },
                    { id: "a02", name: "Bruschetta", category: "appetizer", allergens: ["gluten"], cuisine: "Italian", health: ["lycopene"], tags: ["vegan"], calories: 180, sugar: 5, sodium: 250, healthScore: 80 },
                    { id: "a03", name: "Spring Rolls", category: "appetizer", allergens: ["gluten", "soy"], cuisine: "Asian", health: [], tags: ["vegetarian"], calories: 200, sugar: 4, sodium: 450, healthScore: 60 },
                    { id: "a04", name: "Garlic Bread", category: "appetizer", allergens: ["gluten", "dairy"], cuisine: "International", health: [], tags: ["vegetarian"], calories: 220, sugar: 2, sodium: 350, healthScore: 50 },
                    { id: "a05", name: "Steamed Edamame", category: "appetizer", allergens: ["soy"], cuisine: "Asian", health: ["protein", "fiber"], tags: ["vegan", "gluten-free", "healthy"], calories: 120, sugar: 2, sodium: 200, healthScore: 90 },
                    { id: "a06", name: "Caprese Skewers", category: "appetizer", allergens: ["dairy"], cuisine: "Italian", health: ["calcium"], tags: ["vegetarian", "gluten-free"], calories: 150, sugar: 3, sodium: 180, healthScore: 82 },
                    { id: "a07", name: "Stuffed Mushrooms", category: "appetizer", allergens: ["dairy", "gluten"], cuisine: "International", health: [], tags: ["vegetarian"], calories: 280, sugar: 4, sodium: 400, healthScore: 68 },
                    { id: "a08", name: "Shrimp Cocktail", category: "appetizer", allergens: ["shellfish"], cuisine: "International", health: ["protein"], tags: ["gluten-free"], calories: 140, sugar: 8, sodium: 350, healthScore: 85 },
                    { id: "a09", name: "Onion Rings", category: "appetizer", allergens: ["gluten"], cuisine: "American", health: [], tags: ["vegetarian"], calories: 350, sugar: 5, sodium: 500, healthScore: 40 },
                    { id: "a10", name: "Samosas", category: "appetizer", allergens: ["gluten"], cuisine: "Indian", health: [], tags: ["vegetarian", "spicy"], calories: 260, sugar: 3, sodium: 450, healthScore: 55 },

                    // Soups
                    { id: "s01", name: "Lentil Soup", category: "soup", allergens: [], cuisine: "Mediterranean", health: ["fiber", "protein"], tags: ["vegan", "gluten-free", "healthy"], calories: 180, sugar: 5, sodium: 400, healthScore: 92 },
                    { id: "s02", name: "Tomato Soup", category: "soup", allergens: ["dairy"], cuisine: "International", health: ["lycopene", "vitamin-c"], tags: ["vegetarian", "gluten-free"], calories: 150, sugar: 12, sodium: 480, healthScore: 85 },
                    { id: "s03", name: "Chicken Noodle Soup", category: "soup", allergens: ["gluten"], cuisine: "American", health: ["protein"], tags: [], calories: 160, sugar: 3, sodium: 550, healthScore: 80 },
                    { id: "s04", name: "Miso Soup", category: "soup", allergens: ["soy"], cuisine: "Japanese", health: ["probiotics"], tags: ["vegan", "gluten-free"], calories: 40, sugar: 1, sodium: 600, healthScore: 78 },
                    { id: "s05", name: "Butternut Squash Soup", category: "soup", allergens: [], cuisine: "International", health: ["vitamin-a", "fiber"], tags: ["vegan", "gluten-free"], calories: 170, sugar: 15, sodium: 450, healthScore: 88 },
                    { id: "s06", name: "French Onion Soup", category: "soup", allergens: ["gluten", "dairy"], cuisine: "French", health: [], tags: [], calories: 300, sugar: 8, sodium: 800, healthScore: 50 },
                    { id: "s07", name: "Hot and Sour Soup", category: "soup", allergens: ["soy", "eggs"], cuisine: "Asian", health: [], tags: ["spicy", "sour"], calories: 90, sugar: 6, sodium: 750, healthScore: 65 },

                    // Breakfast
                    { id: "b01", name: "Scrambled Eggs", category: "breakfast", allergens: ["eggs", "dairy"], cuisine: "American", health: ["protein", "vitamin-d"], tags: ["high-protein", "gluten-free"], calories: 180, sugar: 1, sodium: 200, healthScore: 85 },
                    { id: "b02", name: "Whole Grain Pancakes", category: "breakfast", allergens: ["gluten", "eggs", "dairy"], cuisine: "American", health: ["fiber", "complex-carbs"], tags: ["high-fiber", "vegetarian"], calories: 250, sugar: 8, sodium: 350, healthScore: 70 },
                    { id: "b03", name: "Oatmeal with Berries", category: "breakfast", allergens: [], cuisine: "International", health: ["fiber", "antioxidants"], tags: ["vegan", "gluten-free", "healthy"], calories: 200, sugar: 12, sodium: 10, healthScore: 95 },
                    { id: "b04", name: "Greek Yogurt with Honey", category: "breakfast", allergens: ["dairy"], cuisine: "Mediterranean", health: ["protein", "probiotics", "calcium"], tags: ["high-protein", "vegetarian"], calories: 150, sugar: 20, sodium: 80, healthScore: 80 },
                    { id: "b05", name: "Avocado Toast", category: "breakfast", allergens: ["gluten"], cuisine: "International", health: ["healthy-fats", "fiber"], tags: ["vegan"], calories: 280, sugar: 2, sodium: 300, healthScore: 88 },
                    { id: "b06", name: "Breakfast Burrito", category: "breakfast", allergens: ["gluten", "eggs", "dairy"], cuisine: "Mexican", health: ["protein", "fiber"], tags: [], calories: 450, sugar: 4, sodium: 700, healthScore: 65 },
                    { id: "b07", name: "Smoked Salmon Bagel", category: "breakfast", allergens: ["gluten", "fish", "dairy"], cuisine: "American", health: ["omega-3", "protein"], tags: [], calories: 380, sugar: 5, sodium: 650, healthScore: 75 },
                    { id: "b08", name: "Fresh Fruit Platter", category: "breakfast", allergens: [], cuisine: "International", health: ["vitamins", "fiber", "antioxidants"], tags: ["gluten-free", "vegan", "healthy"], calories: 120, sugar: 25, sodium: 5, healthScore: 95 },

                    // Salads
                    { id: "sa01", name: "Quinoa Salad", category: "salad", allergens: [], cuisine: "Mediterranean", health: ["protein", "fiber", "iron"], tags: ["gluten-free", "vegan", "high-protein"], calories: 180, sugar: 4, sodium: 120, healthScore: 90 },
                    { id: "sa02", name: "Grilled Chicken Salad", category: "salad", allergens: [], cuisine: "American", health: ["protein", "low-carb", "vitamins"], tags: ["gluten-free", "high-protein", "low-carb"], calories: 220, sugar: 3, sodium: 180, healthScore: 88 },
                    { id: "sa03", name: "Caesar Salad", category: "salad", allergens: ["gluten", "dairy", "fish"], cuisine: "International", health: [], tags: [], calories: 350, sugar: 2, sodium: 400, healthScore: 60 },
                    { id: "sa04", name: "Greek Salad", category: "salad", allergens: ["dairy"], cuisine: "Mediterranean", health: ["vitamins", "healthy-fats"], tags: ["vegetarian", "gluten-free"], calories: 280, sugar: 6, sodium: 500, healthScore: 82 },
                    { id: "sa05", name: "Garden Salad", category: "salad", allergens: [], cuisine: "International", health: ["vitamins", "fiber"], tags: ["vegan", "gluten-free", "healthy"], calories: 80, sugar: 4, sodium: 50, healthScore: 95 },
                    { id: "sa06", name: "Cobb Salad", category: "salad", allergens: ["eggs", "dairy"], cuisine: "American", health: ["protein"], tags: ["gluten-free"], calories: 450, sugar: 5, sodium: 600, healthScore: 70 },
                    { id: "sa07", name: "Tuna Salad", category: "salad", allergens: ["fish", "eggs"], cuisine: "American", health: ["protein", "omega-3"], tags: ["gluten-free"], calories: 380, sugar: 2, sodium: 450, healthScore: 75 },
                    { id: "sa08", name: "Pasta Salad", category: "salad", allergens: ["gluten"], cuisine: "Italian", health: [], tags: ["vegetarian"], calories: 360, sugar: 7, sodium: 550, healthScore: 62 },

                    // Main Courses
                    { id: "m01", name: "Grilled Salmon", category: "main", allergens: ["fish"], cuisine: "International", health: ["omega-3", "protein", "heart-healthy"], tags: ["gluten-free", "high-protein", "healthy"], calories: 280, sugar: 1, sodium: 150, healthScore: 92 },
                    { id: "m02", name: "Vegetable Stir Fry", category: "main", allergens: ["soy"], cuisine: "Asian", health: ["vegetables", "fiber", "vitamins"], tags: ["vegan", "high-fiber", "healthy"], calories: 200, sugar: 8, sodium: 400, healthScore: 85 },
                    { id: "m03", name: "Spicy Chicken Wings", category: "main", allergens: [], cuisine: "American", health: ["protein"], tags: ["spicy", "high-protein"], calories: 450, sugar: 5, sodium: 800, healthScore: 55 },
                    { id: "m04", name: "Lemon Herb Chicken", category: "main", allergens: [], cuisine: "Mediterranean", health: ["protein", "low-carb"], tags: ["sour", "healthy", "low-carb"], calories: 320, sugar: 2, sodium: 250, healthScore: 88 },
                    { id: "m05", name: "Beef Lasagna", category: "main", allergens: ["gluten", "dairy"], cuisine: "Italian", health: ["protein", "calcium"], tags: [], calories: 550, sugar: 10, sodium: 900, healthScore: 50 },
                    { id: "m06", name: "Mushroom Risotto", category: "main", allergens: ["dairy"], cuisine: "Italian", health: [], tags: ["vegetarian", "gluten-free"], calories: 480, sugar: 5, sodium: 700, healthScore: 65 },
                    { id: "m07", name: "Tofu Pad Thai", category: "main", allergens: ["soy", "nuts"], cuisine: "Thai", health: ["protein"], tags: ["vegan"], calories: 520, sugar: 15, sodium: 850, healthScore: 68 },
                    { id: "m08", name: "Steak with Mashed Potatoes", category: "main", allergens: ["dairy"], cuisine: "American", health: ["protein", "iron"], tags: ["high-protein"], calories: 650, sugar: 4, sodium: 600, healthScore: 58 },
                    { id: "m09", name: "Fish and Chips", category: "main", allergens: ["gluten", "fish"], cuisine: "British", health: [], tags: [], calories: 700, sugar: 3, sodium: 800, healthScore: 40 },
                    { id: "m10", name: "Vegetable Curry", category: "main", allergens: [], cuisine: "Indian", health: ["fiber", "vitamins"], tags: ["vegan", "gluten-free", "spicy"], calories: 350, sugar: 9, sodium: 550, healthScore: 80 },
                    { id: "m11", name: "Chicken Alfredo", category: "main", allergens: ["gluten", "dairy"], cuisine: "Italian", health: ["protein"], tags: [], calories: 680, sugar: 6, sodium: 1000, healthScore: 45 },
                    { id: "m12", name: "Beef Tacos", category: "main", allergens: ["gluten", "dairy"], cuisine: "Mexican", health: ["protein"], tags: [], calories: 480, sugar: 4, sodium: 750, healthScore: 60 },
                    { id: "m13", name: "Lamb Chops", category: "main", allergens: [], cuisine: "Mediterranean", health: ["protein", "iron"], tags: ["gluten-free", "high-protein"], calories: 520, sugar: 2, sodium: 400, healthScore: 70 },
                    { id: "m14", name: "Sushi Platter", category: "main", allergens: ["fish", "soy"], cuisine: "Japanese", health: ["omega-3"], tags: [], calories: 400, sugar: 10, sodium: 600, healthScore: 78 },
                    { id: "m15", name: "BBQ Ribs", category: "main", allergens: [], cuisine: "American", health: ["protein"], tags: ["sweet"], calories: 750, sugar: 30, sodium: 950, healthScore: 35 },
                    
                    // Desserts
                    { id: "de01", name: "Salted Caramel Brownie", category: "dessert", allergens: ["gluten", "dairy", "eggs"], cuisine: "International", health: [], tags: ["dessert", "salty", "sweet"], calories: 620, sugar: 50, sodium: 350, healthScore: 35 },
                    { id: "de02", name: "Chocolate Lava Cake", category: "dessert", allergens: ["gluten", "dairy", "eggs"], cuisine: "International", health: [], tags: ["dessert", "sweet", "vegetarian"], calories: 550, sugar: 45, sodium: 250, healthScore: 40 },
                    { id: "de03", name: "Dessert Fruit Platter", category: "dessert", allergens: [], cuisine: "International", health: ["vitamins", "fiber", "antioxidants"], tags: ["gluten-free", "vegan", "healthy", "sweet"], calories: 120, sugar: 25, sodium: 5, healthScore: 95 },
                    { id: "de04", name: "New York Cheesecake", category: "dessert", allergens: ["gluten", "dairy", "eggs"], cuisine: "American", health: [], tags: ["dessert", "sweet", "vegetarian"], calories: 400, sugar: 30, sodium: 300, healthScore: 45 },
                    { id: "de05", name: "Tiramisu", category: "dessert", allergens: ["gluten", "dairy", "eggs"], cuisine: "Italian", health: [], tags: ["dessert", "sweet", "vegetarian"], calories: 450, sugar: 35, sodium: 150, healthScore: 50 },
                    { id: "de06", name: "Apple Crumble", category: "dessert", allergens: ["gluten", "dairy"], cuisine: "British", health: ["fiber"], tags: ["dessert", "sweet", "vegetarian"], calories: 380, sugar: 40, sodium: 200, healthScore: 60 },
                    { id: "de07", name: "Sorbet (Lemon)", category: "dessert", allergens: [], cuisine: "International", health: [], tags: ["dessert", "sweet", "vegan", "gluten-free", "sour"], calories: 150, sugar: 30, sodium: 20, healthScore: 70 },
                    { id: "de08", name: "Panna Cotta", category: "dessert", allergens: ["dairy"], cuisine: "Italian", health: [], tags: ["dessert", "sweet", "vegetarian", "gluten-free"], calories: 320, sugar: 25, sodium: 100, healthScore: 55 },
                    { id: "de09", name: "Baklava", category: "dessert", allergens: ["gluten", "nuts"], cuisine: "Mediterranean", health: [], tags: ["dessert", "sweet", "vegetarian"], calories: 400, sugar: 35, sodium: 50, healthScore: 48 },
                    { id: "de10", name: "Ice Cream (Vanilla)", category: "dessert", allergens: ["dairy", "eggs"], cuisine: "International", health: [], tags: ["dessert", "sweet", "vegetarian", "gluten-free"], calories: 250, sugar: 20, sodium: 120, healthScore: 60 }
                ];
            }
        }

        // Enhanced User Profile
        let userProfile = {
            allergies: [],
            diet: [],
            conditions: [],
            preferences: [],
            dislikedFoods: [], // Not used yet, but good for future
            phobias: [],
            healthGoals: []
        };

        // Enhanced Meal Plan
        let mealPlan = {
            breakfast: [],
            lunch: [],
            dinner: [],
            snacks: []
        };

        // DOM Elements
        const chatMessages = document.getElementById('chat-messages');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const recommendedFoods = document.getElementById('recommended-foods');
        const mealPlanContainer = document.getElementById('meal-plan-container');
        const suggestedQuestions = document.querySelectorAll('.suggested-question');
        const quickReplies = document.querySelectorAll('.quick-reply');
        const foodSelector = document.getElementById('food-selector');
        const closeSelector = document.getElementById('close-selector');
        const foodCategories = document.getElementById('food-categories');
        const foodOptions = document.getElementById('food-options');

        // Current meal being edited
        let currentMeal = '';

        // Get visitor ID for namespacing localStorage
        const visitorId = localStorage.getItem('visitorId') || '#guest'; 

        // Initialize the chat
        async function init() {
            await fetchFoodDatabase();
            setupEventListeners();
            await loadSavedPreferences();
        }

        // Enhanced Event Listeners
        function setupEventListeners() {
            sendBtn.addEventListener('click', sendMessage);
            userInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });

            // Suggested questions
            suggestedQuestions.forEach(button => {
                button.addEventListener('click', () => {
                    userInput.value = button.getAttribute('data-question');
                    sendMessage();
                });
            });

            // Quick replies
            quickReplies.forEach(reply => {
                reply.addEventListener('click', () => {
                    const replyText = reply.getAttribute('data-reply');
                    addMessage(replyText, 'user');
                    processUserMessage(replyText);
                });
            });

            // Close food selector
            closeSelector.addEventListener('click', () => {
                foodSelector.style.display = 'none';
            });

            // Close selector when clicking outside
            window.addEventListener('click', (e) => {
                if (e.target === foodSelector) {
                    foodSelector.style.display = 'none';
                }
            });
        }

        async function loadSavedPreferences() {
            if (!window.db || visitorId === '#guest') {
                updateMealPlanUI(); // Show empty plan
                displayRecommendedFoods(getRecommendedFoods().slice(0, 6));
                return;
            }
            const visitorDocRef = window.firebase.doc(window.db, "visitors", visitorId);
            const docSnap = await window.firebase.getDoc(visitorDocRef);

            if (docSnap.exists()) {
                const data = docSnap.data();
                if (data.dietaryPreferences) userProfile = { ...userProfile, ...data.dietaryPreferences };
                if (data.mealPlan) mealPlan = data.mealPlan;
            }
            // Always update UI and recommendations after loading
            updateMealPlanUI();
            displayRecommendedFoods(getRecommendedFoods().slice(0, 6));
        }

        // Enhanced Message Handling
        function sendMessage() {
            const message = userInput.value.trim();
            if (message) {
                addMessage(message, 'user');
                processUserMessage(message);
                userInput.value = '';
            }
        }

        function addMessage(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            
            if (sender === 'user') {
                messageDiv.innerHTML = `<i class="fas fa-user" style="margin-right: 8px;"></i>${text}`;
            } else {
                messageDiv.textContent = text;
            }
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addBotMessage(text, quickReplies = []) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message bot-message';
            messageDiv.innerHTML = `<i class="fas fa-robot" style="margin-right: 8px;"></i>${text}`;
            
            if (quickReplies.length > 0) {
                const repliesDiv = document.createElement('div');
                repliesDiv.className = 'quick-replies';
                
                quickReplies.forEach(reply => {
                    const replySpan = document.createElement('span');
                    replySpan.className = 'quick-reply';
                    replySpan.textContent = reply.text;
                    replySpan.setAttribute('data-reply', reply.text);
                    replySpan.addEventListener('click', () => {
                        addMessage(reply.text, 'user');
                        if (reply.action) {
                            reply.action();
                        } else {
                            processUserMessage(reply.text);
                        }
                    });
                    repliesDiv.appendChild(replySpan);
                });
                
                messageDiv.appendChild(repliesDiv);
            }
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            typingDiv.id = 'typing-indicator';
            typingDiv.innerHTML = '<div class="typing-dots"><span></span><span></span><span></span></div>';
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // Enhanced AI Response System
        function processUserMessage(message) {
            showTypingIndicator();
            
            setTimeout(() => {
                hideTypingIndicator();
                generateResponse(message.toLowerCase());
            }, 1000);
        }

        function generateResponse(message) {
            updateUserProfile(message);
            
            if (message.includes('meal plan') || message.includes('my plan')) {
                handleMealPlanQuery();
            } else if (message.includes('allerg') || message.includes('allergic')) {
                handleAllergyQuery(message);
            } else if (message.includes('diet') || message.includes('vegan') || message.includes('vegetarian')) {
                handleDietQuery(message); // This will now be more robust
            } else if (message.includes('diabet') || message.includes('sugar')) {
                handleConditionQuery(message, 'diabetes');
            } else if (message.includes('heart') || message.includes('blood pressure')) {
                handleConditionQuery(message, 'heart');
            } else if (message.includes('gluten')) {
                handleAllergyQuery('gluten');
            } else if (message.includes('salt') || message.includes('salty')) {
                handleFlavorQuery('salty');
            } else if (message.includes('dessert') || message.includes('sweet')) {
                handleFlavorQuery('dessert');
            } else if (message.includes('luxury') || message.includes('fancy') || message.includes('expensive')) {
                handleLuxuryQuery();
            } else if (message.includes('calorie') || message.includes('weight')) {
                handleWeightManagementQuery();
            } else if (message.includes('safe') || message.includes('what can i eat') || message.includes('recommend')) {
                handleRecommendationQuery();
            } else if (message.includes('healthy') || message.includes('healthiest')) {
                handleHealthQuery();
            } else if (message.includes('calorie')) {
                addBotMessage("Of course, I can help with that. All food recommendations now include calorie counts. What kind of food are you looking for?");
            } else if (message.includes('free from') || (message.includes('free') && (message.includes('gluten') || message.includes('dairy')))) {
                handleFreeFromQuery(message);
            } else {
                // Fallback for phobias and other keywords if not caught by allergy handler
                if (handlePhobiaQuery(message)) return;

                addBotMessage("I'm here to help you find safe and enjoyable foods based on your dietary needs. You can tell me about any allergies, dietary restrictions, or health conditions.", [
                    { text: "I have food allergies" },
                    { text: "I'm on a special diet" },
                    { text: "I have a health condition" },
                    { text: "Show me my meal plan" }
                ]);
            }
        }

        // Enhanced User Profile Management
        function updateUserProfile(message) {
            // Comprehensive allergy keywords mapping to standardized allergy names
            const allergyKeywords = {
                'peanut': 'peanut',
                'almond': 'tree nut', 'walnut': 'tree nut', 'cashew': 'tree nut', 'tree nut': 'tree nut',
                'milk': 'dairy', 'dairy': 'dairy', 'lactose': 'dairy',
                'egg': 'egg',
                'wheat': 'wheat',
                'soy': 'soy',
                'fish': 'fish',
                'shellfish': 'shellfish', 'shrimp': 'shellfish', 'crab': 'shellfish', 'lobster': 'shellfish',
                'pollen': 'pollen', 'hay fever': 'pollen',
                'dust': 'dust mite',
                'pet': 'pet', 'cat': 'pet', 'dog': 'pet',
                'latex': 'latex',
                'bee': 'insect sting', 'wasp': 'insect sting', 'sting': 'insect sting',
                'mold': 'mold',
                'penicillin': 'medication', 'medication': 'medication',
                'fragrance': 'fragrance', 'perfume': 'fragrance',
                'gluten': 'gluten', 'celiac': 'gluten',
                'sesame': 'sesame',
                'nickel': 'nickel',
                'sun': 'sun'
            };
            
            for (const [keyword, allergy] of Object.entries(allergyKeywords)) {
                if (message.includes(keyword) && !userProfile.allergies.includes(allergy)) {
                    userProfile.allergies.push(allergy);
                }
            }
            
            // Extract diets
            if (message.includes('vegan') && !userProfile.diet.includes('vegan')) {
                userProfile.diet.push('vegan');
            }
            if ((message.includes('vegetarian') || message.includes('veg ')) && !userProfile.diet.includes('vegetarian')) {
                userProfile.diet.push('vegetarian');
            }
            if (message.includes('keto') && !userProfile.diet.includes('keto')) {
                userProfile.diet.push('keto');
            }
            if (message.includes('paleo') && !userProfile.diet.includes('paleo')) {
                userProfile.diet.push('paleo');
            }
            
            // Extract conditions
            const conditionKeywords = {
                'diabet': 'diabetes', 'sugar': 'diabetes', 'heart': 'heart disease',
                'blood pressure': 'hypertension', 'hypertension': 'hypertension',
                'kidney': 'kidney disease', 'ibs': 'ibs', 'celiac': 'celiac'
            };
            
            for (const [keyword, condition] of Object.entries(conditionKeywords)) {
                if (message.includes(keyword) && !userProfile.conditions.includes(condition)) {
                    userProfile.conditions.push(condition);
                }
            }
            
            // Extract health goals
            if (message.includes('weight') || message.includes('lose')) {
                userProfile.healthGoals.push('weight loss');
            }
            if (message.includes('muscle') || message.includes('gain')) {
                userProfile.healthGoals.push('muscle gain');
            }
            if (message.includes('energy') || message.includes('energetic')) {
                userProfile.healthGoals.push('energy boost');
            }
        }

        // Enhanced Query Handlers
        function handleAllergyQuery(message) {
            const detectedAllergies = new Set();
            userProfile.allergies.forEach(allergy => {
                if (message.includes(allergy.split(' ')[0])) { // Simple check
                    detectedAllergies.add(allergy);
                }
            });

            // If the message is generic like "I have an allergy"
            if (detectedAllergies.size === 0 && (message.includes('allerg') || message.includes('allergic'))) {
                addBotMessage("I can help with that. Please tell me which allergy you have (e.g., 'I am allergic to peanuts', 'I have a gluten allergy').");
                return;
            }

            const allergyResponses = {
                // Food Allergies
                'peanut': "For a peanut allergy, it's crucial to be careful. Here are 5 options that are peanut-free. Please always double-check with staff about cross-contamination.",
                'tree nut': "For a tree nut allergy, here are 5 nut-free options. I recommend confirming with our staff about preparation methods.",
                'dairy': "For a dairy allergy, you'll want to avoid milk, cheese, and butter. Here are 5 delicious dairy-free options for you.",
                'egg': "For an egg allergy, I've found 5 dishes made without eggs. These should be safe for you.",
                'wheat': "For a wheat allergy, here are 5 wheat-free meal options. Many are also gluten-free.",
                'soy': "For a soy allergy, I've identified 5 meals that do not contain soy. Enjoy!",
                'fish': "For a fish allergy, you should avoid all finned fish. Here are 5 fish-free main courses and salads.",
                'shellfish': "For a shellfish allergy, it's very important to be cautious. Here are 5 options that are free from shrimp, crab, and other shellfish.",
                'gluten': "For gluten sensitivity or Celiac disease, I have filtered our menu for you. Here are 5 strictly gluten-free options.",
                'sesame': "For a sesame allergy, here are 5 options that are prepared without sesame seeds or oil.",
                // Environmental Allergies
                'pollen': "I've noted your pollen allergy. While this doesn't affect your food choices, I'll prioritize indoor locations and alert you to high pollen counts when you use the interactive map.",
                'dust mite': "Thank you for letting me know. I've noted your dust mite allergy. All our partner venues adhere to strict cleanliness standards to ensure your comfort.",
                'pet': "I've noted your pet allergy. I will help you find pet-free zones and restaurants when you use the interactive map.",
                'latex': "I've noted your latex allergy. This is important for our staff to know. I've added this to your profile to ensure safety.",
                'insect sting': "I've noted your allergy to insect stings. I will prioritize indoor dining suggestions and areas away from gardens when you use the interactive map.",
                'mold': "I've noted your mold allergy. Our venues are monitored for air quality, but I will prioritize newer and open-air facilities for you on the map.",
                'medication': "Thank you for sharing. While I can't provide medical advice, I've added this to your profile. Please consult a doctor for any health concerns.",
                'fragrance': "I understand, fragrance sensitivity can be challenging. I've noted this and can help you find locations on the map that are designated as fragrance-free.",
                'nickel': "I've noted your nickel allergy. This typically relates to contact, but I've added it to your profile as a precaution.",
                'sun': "I've noted your sun sensitivity. When suggesting activities on the map, I will prioritize shaded or indoor options for you."
            };

            let responded = false;
            detectedAllergies.forEach(allergy => {
                if (allergyResponses[allergy]) {
                    addBotMessage(allergyResponses[allergy]);
                    // If it's a food allergy, show food recommendations
                    if (['peanut', 'tree nut', 'dairy', 'egg', 'wheat', 'soy', 'fish', 'shellfish', 'gluten', 'sesame'].includes(allergy)) {
                        const safeFoods = getRecommendedFoods().slice(0, 5);
                        if (safeFoods.length > 0) {
                            displayRecommendedFoods(safeFoods);
                        } else {
                            addBotMessage("I'm sorry, but based on your combined preferences, I couldn't find 5 suitable items right now.");
                        }
                    }
                    responded = true;
                }
            });
            if (responded) {
                const foodAllergiesDetected = Array.from(detectedAllergies).some(a => ['peanut', 'tree nut', 'dairy', 'egg', 'wheat', 'soy', 'fish', 'shellfish', 'gluten', 'sesame'].includes(a));
                if (foodAllergiesDetected) {
                    addBotMessage("Would you like me to generate a full meal plan based on this?", [
                        { text: "Yes, generate a safe plan", action: generateMealPlan },
                        { text: "No, thanks" }
                    ]);
                }
                savePreferences(); // Save profile if we made a change
            }
        }

        function handleDietQuery(message) {
            let response = "";
            let suitableFoods = getRecommendedFoods().slice(0, 6);
            
            if (message.includes('vegan')) {
                response = "For a vegan diet, here are some excellent plant-based options, free of all animal products:";
            } else if (message.includes('vegetarian')) {
                response = "For vegetarian preferences, these options are meat-free:";
            } else if (message.includes('keto')) {
                response = "For a keto diet, focus on these low-carb, high-fat options:";
            } else {
                response = "Here are some dietary-friendly options:";
            }
            
            addBotMessage(response);
            displayRecommendedFoods(suitableFoods);
        }

        function handleMealPlanQuery() {
            showMealPlan();
            setTimeout(() => {
                savePreferences(); // Save any profile changes before showing the plan
            }, 500);
        }

        function handleConditionQuery(message, condition) {
            let response = "";
            let suitableFoods = getRecommendedFoods().slice(0, 6);
            
            if (condition === 'diabetes') {
                response = "For diabetes management, focus on these low-glycemic options with balanced nutrition:";
            } else if (condition === 'heart') {
                response = "For heart health, these options are low in sodium and saturated fats:";
            }
            
            addBotMessage(response);
            displayRecommendedFoods(suitableFoods);
        }

        function handleFlavorQuery(flavor) {
            let response = `Craving something ${flavor}? Here are some great options:`;
            const flavorFoods = getRecommendedFoods().filter(food => food.tags.includes(flavor)).slice(0, 6);

            if (flavorFoods.length === 0) {
                response = `I'm sorry, I couldn't find any ${flavor} options that match your current profile. I can look for something else!`;
            }

            addBotMessage(response);
            if (flavorFoods.length > 0) {
                displayRecommendedFoods(flavorFoods);
            }
        }

        function handleFreeFromQuery(message) {
            let filterType = '';
            if (message.includes('gluten')) {
                filterType = 'gluten';
            } else if (message.includes('dairy')) {
                filterType = 'dairy';
            } else if (message.includes('vegan')) {
                filterType = 'vegan';
            }

            if (filterType) {
                addBotMessage(`Certainly! Here are the ${filterType}-free options available:`);
                filterAndDisplayBy(filterType);
            } else {
                addBotMessage("I can filter by 'gluten-free' or 'dairy-free'. Which would you like to see?");
                // Show all recommendations as a fallback
                displayRecommendedFoods(getRecommendedFoods().slice(0, 6));
            }
        }

        function handleLuxuryQuery() {
            addBotMessage("For a luxury dining experience, I can show you some of the finest restaurants on the map. I'll open the map for you now.");
            // Set a flag in localStorage for map.html to read
            localStorage.setItem('map_request', 'luxury_restaurants');
            setTimeout(() => { window.location.href = 'map.html'; }, 2000);
        }

        function handleWeightManagementQuery() {
            const lowCalorieFoods = getRecommendedFoods()
                .filter(food => food.calories < 250)
                .slice(0, 6);
                
            addBotMessage("For weight management, these lower-calorie options are great choices:");
            displayRecommendedFoods(lowCalorieFoods);
        }

        function handleRecommendationQuery() {
            const recommended = getRecommendedFoods().slice(0, 8);
            
            if (recommended.length > 0) {
                addBotMessage("Based on your preferences, here are my top recommendations:");
                displayRecommendedFoods(recommended);
            } else {
                addBotMessage("I need to know more about your dietary needs. Do you have any allergies, dietary restrictions, or health conditions?", [
                    { text: "I have food allergies" },
                    { text: "I'm on a special diet" },
                    { text: "I have a health condition" }
                ]);
            }
        }

        function handlePhobiaQuery(userInput) {
            if (userInput.includes('phobia') || userInput.includes('fear') || userInput.includes('scared') || userInput.includes('anxious')) {
                const phobiaKeywords = {
                    // Actionable phobias that affect map suggestions
                    'crowds': { keywords: ['crowd', 'people', 'open space'], response: "I understand completely. I've noted your concern about crowded places. When you use the Interactive Map, we will automatically suggest quieter locations for you." },
                    'heights': { keywords: ['height', 'high place'], response: "Thank you for letting me know. I've made a note to avoid suggesting locations at significant heights, like observation decks." },
                    'closed spaces': { keywords: ['small space', 'closed space', 'claustrophobia'], response: "I've noted your concern about enclosed spaces. I will prioritize open-air suggestions for you on the map." },
                    'water': { keywords: ['water', 'ocean', 'deep water', 'bathing', 'swimming'], response: "I've noted your fear of water. I will avoid suggesting activities on or near large bodies of water." },
                    'dark': { keywords: ['dark', 'night'], response: "Thank you for sharing. I'll prioritize well-lit and daytime activities for you." },
                    'bridges': { keywords: ['bridge'], response: "I've noted your concern about bridges. I'll do my best to suggest routes and places that avoid them where possible." },
                    'forests': { keywords: ['forest', 'woods'], response: "I understand. I will avoid suggesting activities in forested or densely wooded areas." },

                    // Animal/Insect phobias
                    'spiders': { keywords: ['spider'], response: "I understand. I've noted your concern. Rest assured, all our recommended indoor venues are professionally maintained." },
                    'snakes': { keywords: ['snake'], response: "I understand. I've noted your concern. It's highly unlikely to encounter snakes in urban areas, and I'll avoid suggesting remote nature trails." },
                    'dogs': { keywords: ['dog'], response: "I've noted your concern about dogs. I can suggest places that are less likely to have off-leash animals." },
                    'insects': { keywords: ['insect', 'bug'], response: "I understand. I've noted your concern. I will prioritize indoor activities for you." },
                    'animals': { keywords: ['animal'], response: "I've noted your concern about animals. I will be mindful of this when making suggestions." },

                    // Other common phobias with generic responses
                    'flying': { keywords: ['flying', 'airplane'], response: "I've made a note of that in your profile. Thank you for sharing." },
                    'needles': { keywords: ['needle', 'injection'], response: "I've made a note of that. Thank you for letting me know." },
                    'germs': { keywords: ['germ', 'bacteria', 'virus'], response: "I understand. I can assure you that our partners maintain the highest standards of cleanliness. I've noted this in your profile." },
                    'hospitals': { keywords: ['hospital', 'doctor', 'dentist'], response: "I understand completely and have made a note of it in your profile." },
                    'thunder': { keywords: ['thunder', 'lightning', 'storm'], response: "I've noted your concern. In case of a storm, I can suggest secure, indoor locations." },
                    'loud noises': { keywords: ['loud noise', 'loud sound'], response: "I understand. I will prioritize quieter locations for you, away from heavy traffic or construction." },
                    'being watched': { keywords: ['watched', 'stared at'], response: "I understand. I will suggest more private or less crowded spots for you." },
                    'being alone': { keywords: ['alone', 'lonely'], response: "I understand. I can suggest more social and lively places if that would make you more comfortable." },
                };

                let phobiaDetected = false;

                for (const phobiaName in phobiaKeywords) {
                    const data = phobiaKeywords[phobiaName];
                    if (data.keywords.some(keyword => userInput.includes(keyword))) {
                        // Add the phobia to the user's profile if it's not already there
                        if (!userProfile.phobias.includes(phobiaName)) {
                            userProfile.phobias.push(phobiaName);
                        }
                        // Send the specific response for that phobia
                        addBotMessage(data.response);
                        phobiaDetected = true;
                        break; // Stop after the first match
                    }
                }

                // If no specific phobia was detected from the keywords
                if (!phobiaDetected) {
                    // Check for the general words 'phobia', 'fear', 'scared'
                    if (userInput.includes('phobia') || userInput.includes('fear') || userInput.includes('scared')) {
                        addBotMessage("I can make a note of specific fears or phobias to help tailor your experience. Could you tell me more about what you're concerned about? For example, 'I have a fear of heights' or 'I'm anxious in crowds'.");
                    } else {
                        // This case is for when 'anxious' is the only trigger word without other context
                        if (!userProfile.phobias.includes('general anxiety')) {
                            userProfile.phobias.push('general anxiety');
                        }
                        addBotMessage("I understand. Feeling anxious is challenging. I've made a note in your profile. We can prioritize calm and relaxing activities for you.");
                    }
                }

                // Save the updated profile to localStorage
                displayRecommendedFoods(getRecommendedFoods().slice(0, 6)); // Refresh recommendations
                savePreferences();
                return true; // Indicate that we handled the message
            }
            return false; // Indicate that we did not handle the message
        }

        function handleHealthQuery() {
            const healthyFoods = getRecommendedFoods()
                .filter(food => food.healthScore >= 80)
                .slice(0, 6);
            
            addBotMessage("For optimal health, these nutrient-rich options are excellent choices:");
            displayRecommendedFoods(healthyFoods);
        }

        // Enhanced Food Recommendation Algorithm
        function getRecommendedFoods() {
            return foodDatabase
                .filter(food => {
                    // Check for allergens
                    const hasAllergen = userProfile.allergies.some(allergy => 
                        food.allergens.includes(allergy)
                    );
                    if (hasAllergen) return false;
                    
                    // Check for diet compatibility
                    if (userProfile.diet.includes('vegan') && !food.tags.includes('vegan')) {
                        return false;
                    }
                    if (userProfile.diet.includes('vegetarian') && 
                        !(food.tags.includes('vegetarian') || food.tags.includes('vegan'))) {
                        return false;
                    }
                    if (userProfile.diet.includes('keto') && food.tags.includes('high-carb')) {
                        return false;
                    }
                    
                    // Check for condition compatibility
                    if (userProfile.conditions.includes('diabetes') && food.sugar > 15) {
                        return false;
                    }
                    if (userProfile.conditions.includes('hypertension') && food.sodium > 300) {
                        return false;
                    }
                    if (userProfile.conditions.includes('heart disease') && food.tags.includes('high-fat')) {
                        return false;
                    }
                    
                    return true;
                })
                .sort((a, b) => b.healthScore - a.healthScore);
        }

        // Enhanced Food Display
        function displayRecommendedFoods(foods) {
            recommendedFoods.innerHTML = '';
            
            foods.forEach(food => {
                const foodItem = document.createElement('div');
                foodItem.className = 'food-item';
                
                let badgeClass = 'badge-safe';
                let badgeText = 'Excellent Choice';
                
                if (food.healthScore < 70) {
                    badgeClass = 'badge-caution';
                    badgeText = 'Moderate Choice';
                }
                if (food.healthScore < 50) {
                    badgeClass = 'badge-avoid';
                    badgeText = 'Limited Consumption';
                }
                
                const healthScoreClass = food.healthScore >= 80 ? 'score-high' : 
                                      food.healthScore >= 60 ? 'score-medium' : 'score-low';
                
                foodItem.innerHTML = `
                    <div class="food-name">
                        ${food.name}
                        <span class="health-score ${healthScoreClass}">${food.healthScore}</span>
                    </div>
                    <div class="food-details">
                        ${food.cuisine}  <b>${food.calories} calories</b>
                    </div>
                    ${food.allergens.length > 0 ? `
                        <div class="allergy-tags">
                            ${food.allergens.map(allergy => `<span class="allergy-tag">${allergy}</span>`).join('')}
                        </div>
                    ` : ''}
                    <div class="health-indicator">
                        <i class="fas fa-heart ${healthScoreClass.replace('score-', 'health-')}"></i>
                        <span>${badgeText}</span>
                    </div>
                `;
                
                foodItem.addEventListener('click', () => {
                    addMessage(`Tell me more about ${food.name}`, 'user');
                    processUserMessage(`nutrition ${food.name}`);
                });
                
                recommendedFoods.appendChild(foodItem);
            });
        }

        // New function to filter and display based on sidebar buttons
        function filterAndDisplayBy(filterType) {
            let filteredFoods = [];
            const allFoods = getRecommendedFoods(); // Start with foods that are already safe for the user

            if (filterType === 'gluten') {
                filteredFoods = allFoods.filter(food => !food.allergens.includes('gluten'));
            } else if (filterType === 'dairy') {
                filteredFoods = allFoods.filter(food => !food.allergens.includes('dairy'));
            } else if (filterType === 'vegan') {
                filteredFoods = allFoods.filter(food => food.tags.includes('vegan'));
            } else if (filterType === 'low-calorie') {
                filteredFoods = allFoods.filter(food => food.calories < 300);
            } else { // 'all'
                filteredFoods = allFoods;
            }

            displayRecommendedFoods(filteredFoods.slice(0, 10)); // Show up to 10 items
        }

        // New function to open a dedicated dietary browser modal
        function openDietaryBrowser() {
            // We can reuse the existing food selector modal for this
            currentMeal = null; // We are not adding to a meal
            foodSelector.style.display = 'flex';
            
            const dietaryCategories = [
                { id: 'gluten-free', name: 'Gluten-Free' },
                { id: 'dairy-free', name: 'Dairy-Free' },
                { id: 'vegan', name: 'Vegan' },
                { id: 'vegetarian', name: 'Vegetarian' },
                { id: 'low-calorie', name: 'Low Calorie (< 300)' },
                { id: 'low-sugar', name: 'Low Sugar (< 10g)' },
                { id: 'all', name: 'All Safe Foods' }
            ];

            foodCategories.innerHTML = '';
            
            dietaryCategories.forEach(category => {
                const categoryElement = document.createElement('div');
                categoryElement.className = 'food-category';
                categoryElement.textContent = category.name;
                categoryElement.addEventListener('click', () => {
                    document.querySelectorAll('.food-category').forEach(cat => cat.classList.remove('active'));
                    categoryElement.classList.add('active');
                    
                    let foodsToShow = getRecommendedFoods();
                    if (category.id === 'gluten-free') foodsToShow = foodsToShow.filter(f => !f.allergens.includes('gluten'));
                    if (category.id === 'dairy-free') foodsToShow = foodsToShow.filter(f => !f.allergens.includes('dairy'));
                    if (category.id === 'vegan') foodsToShow = foodsToShow.filter(f => f.tags.includes('vegan'));
                    if (category.id === 'vegetarian') foodsToShow = foodsToShow.filter(f => f.tags.includes('vegetarian') || f.tags.includes('vegan'));
                    if (category.id === 'low-calorie') foodsToShow = foodsToShow.filter(f => f.calories < 300);
                    if (category.id === 'low-sugar') foodsToShow = foodsToShow.filter(f => f.sugar < 10);
                    
                    showFoodsByCategory(null, foodsToShow); // Pass the pre-filtered list
                });
                foodCategories.appendChild(categoryElement);
            });
            
            foodCategories.children[0].click(); // Automatically click the first category
        }

        // Meal Plan Functions (same as before but enhanced)
        function showMealPlan() {
            // Check if the meal plan is empty (all meal arrays are empty)
            const isPlanEmpty = Object.values(mealPlan).every(meal => !meal || meal.length === 0); // Check for null/undefined arrays too
            if (isPlanEmpty) {
                addBotMessage("It looks like you don't have a meal plan yet. Let me generate one for you!");
                generateMealPlan(); // Generate a plan if it's empty
            } else {
                addBotMessage("Here's your personalized meal plan. You can customize each meal by adding or removing items.");
            }

            // The meal plan is already visible, so we just scroll to it.
            const sidebar = document.querySelector('.sidebar');
            
            setTimeout(() => {
                sidebar.scrollTo({ top: 0, behavior: 'smooth' });
            }, 300);
        }

        function generateMealPlan() {
            const recommendedFoods = getRecommendedFoods();
            
            // Helper function to shuffle an array
            const shuffle = (array) => {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            };

            // Separate foods by category for easier selection
            const foodsByCategory = {
                breakfast: shuffle(recommendedFoods.filter(f => f.category === 'breakfast' && f.name.toLowerCase() !== 'fresh fruit platter')),
                side: shuffle(recommendedFoods.filter(f => (f.category === 'breakfast' || f.category === 'appetizer') && f.healthScore > 85)), // e.g., fruits, yogurt
                salad: shuffle(recommendedFoods.filter(f => f.category === 'salad')),
                soup: shuffle(recommendedFoods.filter(f => f.category === 'soup')),
                main: shuffle(recommendedFoods.filter(f => f.category === 'main')),
                dessert: shuffle(recommendedFoods.filter(f => f.category === 'dessert')),
                drinks: shuffle(recommendedFoods.filter(f => f.category === 'drinks')),
            };
            
            // Build the meal plan with the new multi-item structure
            mealPlan = {
                breakfast: [ ...foodsByCategory.breakfast.slice(0, 1), ...foodsByCategory.side.slice(0, 1), ...foodsByCategory.drinks.slice(0, 1) ].filter(Boolean).slice(0, 4),
                lunch: [ ...foodsByCategory.main.slice(0, 1), ...foodsByCategory.salad.slice(0, 1), ...foodsByCategory.dessert.slice(0, 1), ...foodsByCategory.drinks.slice(1, 2) ].filter(Boolean).slice(0, 4),
                dinner: [ ...foodsByCategory.main.slice(1, 2), ...foodsByCategory.soup.slice(0, 1), ...foodsByCategory.dessert.slice(1, 2), ...foodsByCategory.drinks.slice(2, 3) ].filter(Boolean).slice(0, 4),
                snacks: []
            };
            
            updateMealPlanUI();
            addBotMessage("I've generated a new meal plan based on your preferences. You can customize it further.");
        }

        function updateMealPlanUI() {
            ['breakfast', 'lunch', 'dinner'].forEach(mealType => {
                const mealItems = document.getElementById(`${mealType}-items`);
                mealItems.innerHTML = '';
                
                if (!mealPlan[mealType] || mealPlan[mealType].length === 0) {
                    mealItems.innerHTML = '<div class="empty-meal">No items selected</div>';
                } else {
                    mealPlan[mealType].forEach(item => {
                        const mealItem = createMealItemElement(item, mealType);
                        mealItems.appendChild(mealItem);
                    });
                }
            });
        }

        function createMealItemElement(food, mealType) {
            const mealItem = document.createElement('div');
            mealItem.className = 'meal-item';
            mealItem.innerHTML = `
                <div>
                    <div class="meal-item-name">${food.name}</div>
                    <div class="food-details">${food.calories} cal  Health: ${food.healthScore}</div>
                </div>
                <div class="meal-item-actions">
                    <button class="meal-item-action" onclick="removeFromMeal('${mealType}', '${String(food.id)}')">&times;</button>
                </div>
            `;
            return mealItem;
        }

        function removeFromMeal(mealType, foodId) {
            mealPlan[mealType] = mealPlan[mealType].filter(item => item.id !== foodId);
            updateMealPlanUI();
        }

        function openFoodSelector(mealType) {
            currentMeal = mealType;
            foodSelector.style.display = 'flex';
            
            const categories = [...new Set(foodDatabase.map(food => food.category))];
            foodCategories.innerHTML = '';
            
            categories.forEach(category => {
                const categoryElement = document.createElement('div');
                categoryElement.className = 'food-category';
                categoryElement.textContent = category.charAt(0).toUpperCase() + category.slice(1);
                categoryElement.addEventListener('click', () => {
                    document.querySelectorAll('.food-category').forEach(cat => {
                        cat.classList.remove('active');
                    });
                    categoryElement.classList.add('active');
                    showFoodsByCategory(category);
                });
                foodCategories.appendChild(categoryElement);
            });
            
            if (categories.length > 0) {
                foodCategories.children[0].classList.add('active');
                showFoodsByCategory(categories[0]);
            }
        }

        function showFoodsByCategory(category, preFilteredFoods = null) {
            // If a pre-filtered list is provided (from the dietary browser), use it.
            // Otherwise, filter by the category name (from the meal plan adder).
            const foods = preFilteredFoods ? preFilteredFoods : getRecommendedFoods().filter(food => food.category === category);
            foodOptions.innerHTML = '';
            
            if (foods.length === 0) foodOptions.innerHTML = '<p>No items match this filter.</p>';

            foods.slice(0, 50).forEach(food => { // Limit to 50 to avoid performance issues
                const healthScoreClass = food.healthScore >= 80 ? 'score-high' : 
                                      food.healthScore >= 60 ? 'score-medium' : 'score-low';
                
                const foodElement = document.createElement('div');
                foodElement.className = 'food-option';
                foodElement.innerHTML = `
                    <div class="food-name">${food.name}</div>
                    <div class="nutrition-info">
                        ${food.cuisine}  ${food.calories} cal
                        <div class="health-indicator">
                            <i class="fas fa-heart ${healthScoreClass.replace('score-', 'health-')}"></i>
                            <span>Score: ${food.healthScore}</span>
                        </div>
                    </div>
                `;
                foodElement.addEventListener('click', () => {
                    // Only add to meal if the modal was opened for that purpose
                    if (currentMeal) {
                        addToMeal(currentMeal, food);
                        foodSelector.style.display = 'none';
                    }
                });
                foodOptions.appendChild(foodElement);
            });
        }

        function addToMeal(mealType, food) {
            if (!mealPlan[mealType].some(item => item.id === food.id)) {
                mealPlan[mealType].push(food);
                updateMealPlanUI();
            }
        }

        async function savePreferences() {
            if (!window.db || visitorId === '#guest') return;
            const visitorDocRef = window.firebase.doc(window.db, "visitors", visitorId);
            await window.firebase.setDoc(visitorDocRef, {
                mealPlan: mealPlan,
                dietaryPreferences: userProfile
            }, { merge: true });
        }

        async function saveMealPlan() {
            await savePreferences();
            addBotMessage("Your meal plan has been saved! We'll have this ready for your stay.");
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
