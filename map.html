<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Dashboard -  HAYYAK </title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="icon" type="image/x-icon" href="favicon.png">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Roboto&family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Leaflet Map Library -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- Leaflet Routing Machine -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

    <style>
        :root {
            --primary: #16243d;
            --secondary: #2a3851;
            --accent: #D4AF37; /* Gold */
            --light: #f8f9fa;
            --dark: #2c3e50;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: var(--light);
            color: var(--dark);
            line-height: 1.6;
            font-family: 'Roboto', sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden; /* Prevent body scroll */
        }

        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 15px 40px;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1001; /* Above map */
        }

        header h1 {
            font-family: 'Tajawal', sans-serif;
            font-size: 2.5rem;
            color: var(--accent);
        }

        .home-btn {
            display: inline-block;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            text-decoration: none;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
            transition: var(--transition);
            border: 1px solid transparent;
        }

        .home-btn:hover {
            background: white;
            color: var(--primary);
            border-color: var(--primary);
        }

        .dashboard-container {
            display: flex;
            flex: 1;
            padding: 20px;
            gap: 20px;
            overflow: hidden;
        }

        #map {
            flex: 1;
            border-radius: 15px;
            box-shadow: var(--shadow);
            z-index: 1;
        }

        .sidebar {
            width: 380px;
            background: white;
            border-radius: 15px;
            box-shadow: var(--shadow);
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .panel h3 {
            font-family: 'Montserrat', sans-serif;
            color: var(--primary);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--accent);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .panel {
            position: relative; /* Required for spinner overlay */
        }

        .spinner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            border-radius: 15px;
            transition: opacity 0.3s ease;
        }

        .spinner {
            border: 5px solid rgba(0, 0, 0, 0.1);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border-left-color: var(--primary);
            animation: spin 1s ease infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .route-step, .suggestion-item {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            background: var(--light);
            transition: var(--transition);
        }

        .route-step .remove-step-btn {
            background: none;
            border: none;
            color: #aaa;
            cursor: pointer;
        }
        .route-step:hover, .suggestion-item:hover {
            transform: translateX(5px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.08);
        }

        .route-step .icon, .suggestion-item .icon {
            font-size: 1.2rem;
            color: var(--accent);
            width: 25px;
            text-align: center;
            padding-top: 3px;
        }

        .route-step .details, .suggestion-item .details {
            flex: 1;
        }

        .route-step .title, .suggestion-item .title {
            font-weight: 600;
            color: var(--dark);
        }

        .route-step .time, .suggestion-item .info {
            font-size: 0.9rem;
            color: #666;
        }

        .add-to-route-btn {
            background: none;
            border: 1px solid var(--primary);
            color: var(--primary);
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: var(--transition);
            margin-top: 8px;
        }

        .add-to-route-btn:hover {
            background: var(--primary);
            color: white;
        }


        .suggestion-item.real-time {
            background: #fffbe6;
            border-left: 4px solid var(--accent);
        }

        .suggestion-item .info .fa-star {
            color: #f5c542;
        }

        .btn-directions {
            width: 100%;
            padding: 12px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .btn-directions:hover {
            background: var(--accent);
            color: var(--primary);
        }

        .btn-directions.active {
            background: #d9534f; /* Danger color */
        }

        .directions-instructions {
            margin-top: 10px;
            font-size: 0.9rem;
            color: #666;
            min-height: 20px;
        }
        /* AI Agent Modal Styles */
        .directions-actions {
            display: flex;
            gap: 10px;
        }

        .btn-clear-markers {
            padding: 12px;
            background: var(--light);
            color: var(--primary);
            border: 1px solid var(--primary);
        }

        .btn-clear-markers:hover {
            background: var(--secondary);
            color: white;
        }
        .floating-btn {
            position: fixed;
            bottom: 30px;
            left: 30px;
            width: 60px;
            height: 60px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            border: none;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            cursor: pointer;
            z-index: 1002;
            transition: var(--transition);
        }

        .floating-btn:hover {
            background: var(--accent);
            transform: scale(1.1);
        }

        .ai-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 2000;
            display: none; /* Hidden by default */
        }

        .ai-modal-content {
            position: absolute;
            border-radius: 15px;
            width: 90%;
            max-width: 450px;
            height: 70vh;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: white;
        }

        .ai-modal-header {
            padding: 15px 20px;
            background: var(--primary);
            color: var(--accent);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: move;
        }

        .ai-modal-header h3 {
            margin: 0;
            font-family: 'Montserrat', sans-serif;
            color: var(--accent);
            border: none;
        }

        .ai-close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .ai-chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .ai-message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 85%;
        }

        .ai-user-msg {
            background: var(--light);
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .ai-bot-msg {
            background: var(--secondary);
            color: white;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

        .ai-chat-input {
            display: flex;
            padding: 15px;
            border-top: 1px solid #e0e0e0;
        }

        .chat-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 24px;
            font-size: 1rem;
            outline: none;
            transition: var(--transition);
        }

        .chat-input:focus {
            border-color: var(--primary);
        }

        .send-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            margin-left: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .send-btn:hover {
            background: var(--secondary);
        }

        /* Responsive Design for Mobile */
        @media (max-width: 768px) {
            body {
                height: auto; /* Allow body to scroll on mobile */
                overflow: auto;
            }
            header {
                padding: 15px 20px;
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            header h1 {
                font-size: 1.8rem;
            }
            .dashboard-container {
                flex-direction: column;
                padding: 10px;
                gap: 10px;
            }
            #map {
                height: 50vh; /* Give map a fixed height */
            }
            .sidebar {
                width: 100%;
                height: auto;
                overflow-y: visible; /* Allow sidebar to expand */
            }
        }

        /* --- START: Added CSS for Locate Button --- */
        .leaflet-control-locate a {
            font-size: 1.2rem;
            line-height: 26px;
            width: 30px;
            height: 30px;
            text-align: center;
            color: var(--primary);
        }
        .leaflet-control-locate a:hover {
            background-color: #f4f4f4;
        }
        /* --- END: Added CSS for Locate Button --- */
    </style>
</head>
<body>

    <header>
        <h1>Smart Dashboard</h1>
        <a href="index.html" class="home-btn"><i class="fas fa-home"></i> Return to Home Page</a>
    </header>

    <div class="dashboard-container">
        <div id="map"></div>
        <div class="sidebar">
            <div class="panel" id="directions-panel">
                <h3><i class="fas fa-directions"></i> Get Directions</h3>
                <div class="directions-actions">
                    <button id="get-directions-btn" class="btn-directions">Start Planning Route</button>
                    <button id="clear-markers-btn" class="btn-directions btn-clear-markers" title="Clear temporary markers"><i class="fas fa-eraser"></i></button>
                </div>
                <p id="directions-instructions" class="directions-instructions"></p>
            </div>
            <div class="panel" id="route-panel">
                <h3><i class="fas fa-route"></i> Your Personalized Route</h3>
                <!-- Route steps will be injected here by JavaScript -->
            </div>
            <div class="panel" id="suggestions-panel">
                <h3><i class="fas fa-lightbulb"></i> Real-Time Suggestions</h3>
                <!-- Suggestions will be injected here by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Centralized Data File -->
    <!-- The data.js file is now imported as a module in the script below -->

    <!-- AI Agent Button and Modal -->
    <button id="ai-agent-btn" class="floating-btn" aria-label="Open AI Agent">
        <i class="fas fa-robot"></i>
    </button>

    <div id="ai-modal" class="ai-modal-overlay">
        <div class="ai-modal-content">
            <div class="ai-modal-header">
                <h3>Mood Advisor</h3>
                <button id="ai-close-btn" class="ai-close-btn">&times;</button>
            </div>
            <div class="ai-chat-messages" id="ai-chat-messages">
                <!-- Messages will be injected here -->
            </div>
            <div class="ai-chat-input">
                <input type="text" id="ai-user-input" class="chat-input" placeholder="Tell me how you feel...">
                <button id="ai-send-btn" class="send-btn"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <script type="module">
        // --- 1. GLOBAL STATE AND CONSTANTS ---
        const map = L.map('map').setView([25.276987, 55.296249], 13); // Centered on Dubai

        // 2. Add a tile layer (the map background)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'Â© <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        const routePanel = document.getElementById('route-panel');
        const suggestionsPanel = document.getElementById('suggestions-panel');

        let currentRoute = [];
        let allSuggestions = [];
        let feelingSuggestions = {}; // Will be populated from Firebase
        let initialRouteMarkers = [];
        let initialSuggestionMarkers = [];
        let directionsControl = null;
        const visitorId = localStorage.getItem('visitorId') || '#guest';
        let suggestionMarkers = []; // For AI agent

        // --- 2. INITIALIZATION ---
        // We must wait for the DOM to be fully loaded before running any scripts
        // that interact with the page or external services like Firebase.
        document.addEventListener('DOMContentLoaded', initializeApp);

        async function initializeApp() {
            showSpinner(routePanel);
            showSpinner(suggestionsPanel);

            // Dynamically import modules ONLY after the DOM is ready.
            // This ensures Firebase is configured before we try to use it.
            const { getRouteData, getSuggestionsData, getMoodSuggestionsData } = await import('./data.js');
            const { db, doc, setDoc, serverTimestamp, getDoc } = await import('./firebase-config.js');
            window.firebase = { db, doc, setDoc, serverTimestamp, getDoc }; // Make available to older parts of the script if needed

            try {
                // Fetch all data concurrently
                const [routeData, suggestionsData, moodData] = await Promise.all([
                    getRouteData(), 
                    getSuggestionsData(),
                    getMoodSuggestionsData() // Fetch mood data
                ]);

                // Assign fetched data to global variables
                currentRoute = routeData;
                allSuggestions = suggestionsData;
                feelingSuggestions = moodData; // This was the missing part
            } catch (error) {
                console.error("Failed to initialize the application:", error);
                hideSpinner(routePanel);
                hideSpinner(suggestionsPanel);
                routePanel.innerHTML += '<p style="color:red;">Could not load route data.</p>';
                suggestionsPanel.innerHTML += '<p style="color:red;">Could not load suggestions.</p>';
            }

            // Once data is ready, render the UI
            renderRoute();
            updateVisitedPlacesCount();
            updateAverageCrowdLevel();
            locateUser();
        }

        // --- START: Added Geolocation Logic ---
        // Function to find the user and show them on the map
        function locateUser() {
            // Show a spinner in the suggestions panel while we find the user and places
            showSpinner(document.getElementById('suggestions-panel'));
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        const userLocation = [lat, lng];

                        // Update suggestions based on the user's location
                        updateSuggestionsBasedOnLocation(userLocation);

                        // Fly to the user's location on the map
                        map.flyTo(userLocation, 15);

                        // Add a special marker for the user's current location
                        L.marker(userLocation, {
                            icon: L.divIcon({
                                className: 'user-location-marker',
                                html: '<i class="fas fa-map-marker-alt" style="color: #007bff; font-size: 2rem;"></i>',
                                iconSize: [24, 40],
                                iconAnchor: [12, 40]
                            })
                        }).addTo(map).bindPopup("<b>You are here</b>").openPopup();
                    },
                    () => {
                        // Handle error (e.g., user denies location access)
                        console.log("Unable to retrieve your location. Defaulting to Dubai.");
                        // If location fails, just show the default suggestions from the fetched data
                        renderSuggestions(allSuggestions);
                        // The map will remain centered on the default location (Dubai)
                    }
                );
            } else {
                console.log("Geolocation is not supported by this browser.");
                renderSuggestions(allSuggestions);
            }
        }

        // --- START: Activity Logging for Admin Dashboard ---
        async function logActivityToFirebase(message, icon, type) {
            const { db, doc, setDoc, serverTimestamp } = window.firebase;
            if (!db || visitorId === '#guest') return;
            const activityRef = doc(db, "userActivities", `${visitorId}_${Date.now()}`);
            try {
                await setDoc(activityRef, {
                    visitorId: visitorId,
                    message: message,
                    icon: icon,
                    type: type,
                    timestamp: serverTimestamp()
                });
            } catch (error) {
                console.error("Error logging activity to Firebase: ", error);
            }
        }
        // Function to update the visited places count in localStorage
        function updateVisitedPlacesCount() {
            const currentPlaceCount = routePanel.querySelectorAll('.route-step').length;
            localStorage.setItem('visitedPlacesCount', currentPlaceCount);
            const count = routePanel.querySelectorAll('.route-step').length;
            updateVisitorInFirebase({ visitedPlaces: count });
        }

        // Function to update the average crowd level in localStorage
        function updateAverageCrowdLevel() {
            if (currentRoute.length === 0) {
                localStorage.setItem('averageCrowdLevel', '0');
                updateVisitorInFirebase({ averageCrowdLevel: 0 });
                return;
            }
            const totalCrowdLevel = currentRoute.reduce((sum, place) => sum + place.crowdLevel, 0);
            const averageCrowdLevel = Math.round(totalCrowdLevel / currentRoute.length);
            localStorage.setItem('averageCrowdLevel', averageCrowdLevel);
            updateVisitorInFirebase({ averageCrowdLevel: averageCrowdLevel });
        }

        async function updateVisitorInFirebase(dataToUpdate) {
            const { db, doc, setDoc } = window.firebase;
            if (!db || visitorId === '#guest') return;
            const visitorDocRef = doc(db, "visitors", visitorId);
            try {
                await setDoc(visitorDocRef, dataToUpdate, { merge: true });
            } catch (error) {
                console.error("Error updating visitor data in Firebase: ", error);
            }
        }

        // Spinner Functions
        function showSpinner(panelElement) {
            const overlay = document.createElement('div');
            overlay.className = 'spinner-overlay';
            overlay.innerHTML = '<div class="spinner"></div>';
            panelElement.appendChild(overlay);
        }

        function hideSpinner(panelElement) {
            const overlay = panelElement.querySelector('.spinner-overlay');
            if (overlay) {
                overlay.remove();
            }
        }
        // Populate Route Panel and Map Markers
        function renderRoute() {
            hideSpinner(routePanel);
            routePanel.innerHTML = '<h3><i class="fas fa-route"></i> Your Personalized Route</h3>'; // Clear previous steps

            // Clear old markers and lines before doing anything else
            initialRouteMarkers.forEach(m => map.removeLayer(m));
            initialRouteMarkers = [];
            if (window.routeLine) map.removeLayer(window.routeLine);

            if (currentRoute.length === 0) {
                return; // Exit if there's nothing to render
            }

            currentRoute.forEach((step, index) => {
                const stepEl = document.createElement('div');
                stepEl.className = 'route-step';
                stepEl.innerHTML = `
                    <div class="icon"><i class="fas ${step.icon}"></i></div>
                    <div class="details">
                        <div class="title">${index + 1}. ${step.title}</div>
                        <div class="info">${step.time}</div>
                    </div>
                    <button class="remove-step-btn" title="Remove step">&times;</button>
                `;
                routePanel.appendChild(stepEl);

            // Make route step clickable
            stepEl.style.cursor = 'pointer';
            stepEl.addEventListener('click', () => {
                map.flyTo(step.coords, 15);
            });

            // Add marker to map
            const marker = L.marker(step.coords).addTo(map)
                .bindPopup(`<b>${step.title}</b><br>${step.time}`)
                .openPopup();
            initialRouteMarkers.push(marker);
            
            // Add logic to the remove button
            const removeBtn = stepEl.querySelector('.remove-step-btn');
            removeBtn.addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent the flyTo event
                stepEl.remove();
                currentRoute = currentRoute.filter(item => item.id !== step.id);
                updateVisitedPlacesCount(); // Update count on removal
                updateAverageCrowdLevel(); // Update crowd level on removal
                logActivityToFirebase(`Removed "${step.title}" from route.`, 'fas fa-times-circle', 'info');
                renderRoute(); // Re-render the entire route to update numbers and map
            });
            });

            const routeCoordinates = currentRoute.map(step => step.coords);
            currentRoute.forEach(step => {
                const marker = L.marker(step.coords).addTo(map).bindPopup(`<b>${step.title}</b>`);
                initialRouteMarkers.push(marker);
            });

            if (routeCoordinates.length > 1) {
                window.routeLine = L.polyline(routeCoordinates, { color: 'var(--primary)', weight: 5, opacity: 0.7 }).addTo(map);
                map.fitBounds(window.routeLine.getBounds().pad(0.1));
            } else if (routeCoordinates.length === 1) {
                map.flyTo(routeCoordinates[0], 15);
            }
        }

        // --- START: Event Delegation for Dynamic Buttons ---
        suggestionsPanel.addEventListener('click', function(e) {
            if (e.target && e.target.matches('.add-to-route-btn')) {
                const suggestionTitle = e.target.getAttribute('data-suggestion-title');
                const suggestion = allSuggestions.find(s => s.title === suggestionTitle);

                if (suggestion && !currentRoute.some(r => r.title === suggestion.title)) {
                    // Create a new route item from the suggestion
                    const newRouteItem = {
                        id: Date.now(), // Use timestamp for a unique ID
                        title: suggestion.title,
                        time: "Time to be confirmed",
                        icon: suggestion.icon,
                        coords: suggestion.coords,
                        crowdLevel: Math.floor(Math.random() * (80 - 50) + 50) // Assign a random crowd level
                    };

                    currentRoute.push(newRouteItem);
                    renderRoute(); // Re-render the route list and map
                    updateVisitedPlacesCount();
                    updateAverageCrowdLevel();
                    logActivityToFirebase(`Added "${suggestion.title}" to route.`, 'fas fa-plus-circle', 'entry');
                }
            }
        });
        // --- END: Event Delegation ---

        // --- START: Location-Aware Suggestions Logic ---

        // Haversine formula to calculate distance between two points in km
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius of the Earth in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a =
                0.5 - Math.cos(dLat) / 2 +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                (1 - Math.cos(dLon)) / 2;
            return R * 2 * Math.asin(Math.sqrt(a));
        }

        function updateSuggestionsBasedOnLocation(userCoords) {
            const [userLat, userLng] = userCoords;

            // Calculate distance for each suggestion
            const suggestionsWithDistance = allSuggestions
                .filter(s => s.coords) // Only consider suggestions with coordinates
                .map(suggestion => {
                    const distance = getDistance(userLat, userLng, suggestion.coords[0], suggestion.coords[1]);
                    return { ...suggestion, distance };
                });

            // Sort by distance (nearest first)
            suggestionsWithDistance.sort((a, b) => a.distance - b.distance);

            // Get real-time alerts and the 4 nearest places
            const realTimeAlerts = allSuggestions.filter(s => s.realTime && !s.coords);
            const nearbyPlaces = suggestionsWithDistance.slice(0, 4);

            renderSuggestions([...realTimeAlerts, ...nearbyPlaces]);
        }

        function renderSuggestions(suggestionsToRender) {
            hideSpinner(suggestionsPanel);
            suggestionsPanel.innerHTML = '<h3><i class="fas fa-lightbulb"></i> Real-Time Suggestions</h3>'; // Clear previous

            // Clear old suggestion markers from map
            initialSuggestionMarkers.forEach(m => map.removeLayer(m));
            initialSuggestionMarkers = [];

            if (suggestionsToRender.length === 0) {
                suggestionsPanel.innerHTML += '<p>No suggestions found nearby.</p>';
                return;
            }

            suggestionsToRender.forEach(suggestion => {
                const suggestionEl = document.createElement('div');
                suggestionEl.className = `suggestion-item ${suggestion.realTime ? 'real-time' : ''}`;

                let infoHtml = suggestion.info;
                if (suggestion.rating) {
                    infoHtml += ` <span class="rating"><i class="fas fa-star"></i> ${suggestion.rating}</span>`;
                }
                // Add distance if available
                if (suggestion.distance !== undefined) {
                    infoHtml += ` <br><b><i class="fas fa-walking"></i> Approx. ${suggestion.distance.toFixed(1)} km away</b>`;
                }

                let addButtonHtml = '';
                if (suggestion.coords) {
                    addButtonHtml = `<button class="add-to-route-btn" data-suggestion-title="${suggestion.title}"><i class="fas fa-plus"></i> Add to Route</button>`;
                }

                suggestionEl.innerHTML = `
                    <div class="icon"><i class="fas ${suggestion.icon}"></i></div>
                    <div class="details">
                        <div class="title">${suggestion.title}</div>
                        <div class="info">${infoHtml}</div>
                        ${addButtonHtml}
                    </div>
                `;
                suggestionsPanel.appendChild(suggestionEl);

                // Add new markers to map
                if (suggestion.coords) {
                    const marker = L.marker(suggestion.coords, {
                        icon: L.divIcon({
                            className: 'suggestion-marker',
                            html: `<i class="fas fa-lightbulb" style="color: var(--accent); font-size: 1.5rem;"></i>`,
                            iconSize: [24, 24],
                            iconAnchor: [12, 24]
                        })
                    }).addTo(map).bindPopup(`<b>Suggestion:</b><br>${suggestion.title}`);
                    initialSuggestionMarkers.push(marker);
                }
            });
        }

        // --- END: Location-Aware Suggestions Logic ---

        // 5. Directions Logic
        const getDirectionsBtn = document.getElementById('get-directions-btn');
        const directionsInstructions = document.getElementById('directions-instructions');
        let isPlanningRoute = false;
        let routeWaypoints = [];
        let directionPointMarkers = [];

        getDirectionsBtn.addEventListener('click', () => {
            isPlanningRoute = !isPlanningRoute;
            if (isPlanningRoute) {
                getDirectionsBtn.classList.add('active');
                getDirectionsBtn.textContent = 'Cancel Directions';
                directionsInstructions.textContent = 'Click on the map to set a starting point.';
                map.on('click', onMapClickForDirections);
                document.getElementById('map').style.cursor = 'crosshair';
            } else {
                resetDirections();
            }
        });

        function onMapClickForDirections(e) {
            routeWaypoints.push(e.latlng);
            if (routeWaypoints.length === 1) {
                directionsInstructions.textContent = 'Click on the map to set an ending point.';
                const startMarker = L.marker(e.latlng, { title: 'Start' }).addTo(map);
                directionPointMarkers.push(startMarker);
            } else if (routeWaypoints.length === 2) {
                directionsInstructions.textContent = 'Calculating route...';
                const endMarker = L.marker(e.latlng, { title: 'End' }).addTo(map);
                directionPointMarkers.push(endMarker);
                
                directionsControl = L.Routing.control({
                    waypoints: routeWaypoints,
                    routeWhileDragging: true,
                    show: false, // We hide the default instructions panel from the plugin
                    lineOptions: {
                        styles: [{color: 'var(--accent)', opacity: 0.8, weight: 7}]
                    }
                }).addTo(map);

                isPlanningRoute = false;
                getDirectionsBtn.textContent = 'Clear Route';
                getDirectionsBtn.classList.add('active'); // Keep it active to show a route is present
                document.getElementById('map').style.cursor = '';
                map.off('click', onMapClickForDirections);
            }
        }

        function resetDirections() {
            if (directionsControl) map.removeControl(directionsControl);
            getDirectionsBtn.classList.remove('active');
            getDirectionsBtn.textContent = 'Start Planning Route';
            directionsInstructions.textContent = '';
            routeWaypoints = [];
            directionPointMarkers.forEach(marker => map.removeLayer(marker));
            directionPointMarkers = [];
            document.getElementById('map').style.cursor = '';
            map.off('click', onMapClickForDirections);
        }

        // Clear Markers Button Logic
        const clearMarkersBtn = document.getElementById('clear-markers-btn');
        clearMarkersBtn.addEventListener('click', () => {
            // This removes markers from the AI agent and the directions tool
            suggestionMarkers.forEach(marker => map.removeLayer(marker));
            // Also clear initial suggestion markers
            initialSuggestionMarkers.forEach(marker => map.removeLayer(marker));
            initialSuggestionMarkers = [];
            suggestionsPanel.innerHTML = '<h3><i class="fas fa-lightbulb"></i> Real-Time Suggestions</h3>';
            suggestionMarkers = [];
            resetDirections();
        });

        // --- START: AI Agent Logic ---
        const aiAgentBtn = document.getElementById('ai-agent-btn');
        const aiModal = document.getElementById('ai-modal');
        const aiCloseBtn = document.getElementById('ai-close-btn');
        const aiSendBtn = document.getElementById('ai-send-btn');
        const aiUserInput = document.getElementById('ai-user-input');
        const aiChatMessages = document.getElementById('ai-chat-messages');
        const aiModalContent = document.querySelector('.ai-modal-content');
        const aiModalHeader = document.querySelector('.ai-modal-header');

        aiAgentBtn.addEventListener('click', () => {
            aiModal.style.display = 'flex';
            // Center the modal on open
            aiModalContent.style.top = `calc(50% - ${aiModalContent.offsetHeight / 2}px)`;
            aiModalContent.style.left = `calc(50% - ${aiModalContent.offsetWidth / 2}px)`;


            if (aiChatMessages.children.length === 0) {
                addAiMessage("Hello! Tell me how you're feeling today, and I'll suggest some places for you.", 'bot');
            }
        });

        aiCloseBtn.addEventListener('click', () => {
            aiModal.style.display = 'none';
        });

        aiSendBtn.addEventListener('click', handleUserQuery);
        aiUserInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleUserQuery();
        });

        function handleUserQuery() {
            const message = aiUserInput.value.trim();
            if (!message) return;

            addAiMessage(message, 'user');
            aiUserInput.value = '';

            // Show a thinking indicator
            const thinkingMsg = addAiMessage("Thinking...", 'bot');
            processUserFeelingWithAI(message, thinkingMsg);
        }

        function addAiMessage(text, sender) {
            const messageEl = document.createElement('div');
            messageEl.className = `ai-message ${sender === 'user' ? 'ai-user-msg' : 'ai-bot-msg'}`;
            messageEl.innerHTML = text; // Using innerHTML to render links if any
            aiChatMessages.appendChild(messageEl);
            aiChatMessages.scrollTop = aiChatMessages.scrollHeight;
            return messageEl; // Return the element so we can update it
        }

        // --- START: New AI-Powered Mood Advisor Logic ---
        async function processUserFeelingWithAI(message, thinkingMessageElement) {
            // Dynamically import the Gemini API module
            const { getAiMoodSuggestion } = await import('./gemini-api.js');

            // Clear previous AI-generated markers and panel suggestions
            suggestionMarkers.forEach(marker => map.removeLayer(marker));
            suggestionMarkers = [];
            suggestionsPanel.innerHTML = '<h3><i class="fas fa-lightbulb"></i> Mood-Based Suggestions</h3>';
            showSpinner(suggestionsPanel);

            try {
                const aiData = await getAiMoodSuggestion(message);
                
                // Update the "Thinking..." message with the AI's real response
                thinkingMessageElement.innerHTML = aiData.response;

                // The AI doesn't provide coordinates, so we just populate the panel
                // and let the user explore the ideas.
                hideSpinner(suggestionsPanel);
                populateSuggestionsFromAI(aiData.places);

                // Log the successful interaction
                logActivityToFirebase(`User felt '${message}', AI suggested places.`, 'fas fa-robot', 'info');

            } catch (error) {
                console.error("AI processing failed:", error);
                hideSpinner(suggestionsPanel);
                
                // Update the "Thinking..." message with an error
                thinkingMessageElement.innerHTML = `I'm having trouble connecting to my thoughts right now. Please check that the API key is correct or try again in a moment. <br><br>Error: ${error.message}`;
                
                suggestionsPanel.innerHTML += '<p style="color:red;">Could not get AI suggestions.</p>';
            }
        }
        // --- END: New AI-Powered Mood Advisor Logic ---

        // Draggable Modal Logic
        let isDragging = false;
        let offsetX, offsetY;

        aiModalHeader.addEventListener('mousedown', (e) => {
            isDragging = true;
            offsetX = e.clientX - aiModalContent.offsetLeft;
            offsetY = e.clientY - aiModalContent.offsetTop;
            
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        });

        function onMouseMove(e) {
            if (!isDragging) return;
            
            let newX = e.clientX - offsetX;
            let newY = e.clientY - offsetY;

            // Constrain to viewport
            newX = Math.max(0, Math.min(newX, window.innerWidth - aiModalContent.offsetWidth));
            newY = Math.max(0, Math.min(newY, window.innerHeight - aiModalContent.offsetHeight));

            aiModalContent.style.left = `${newX}px`;
            aiModalContent.style.top = `${newY}px`;
        }

        function onMouseUp() {
            isDragging = false;
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
        }

        function populateSuggestionsFromAI(places) {
            places.forEach(suggestion => {
                const suggestionEl = document.createElement('div');
                suggestionEl.className = 'suggestion-item';
                suggestionEl.innerHTML = `
                    <div class="icon"><i class="fas fa-map-marker-alt"></i></div>
                    <div class="details">
                        <div class="title">${suggestion.name}</div>
                        <div class="info">${suggestion.info}</div>
                    </div>
                `;

                if (suggestion.coords) {
                    suggestionEl.style.cursor = 'pointer';
                    suggestionEl.addEventListener('click', () => {
                        map.flyTo(suggestion.coords, 15);
                    });
                }

                suggestionsPanel.appendChild(suggestionEl);
            });
        }
        // --- END: AI Agent Logic ---

    </script>

</body>
</html>